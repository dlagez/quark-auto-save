<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>夸克自动转存</title>
  <!-- CSS -->
  <link rel="stylesheet" href="./static/css/bootstrap.min.css">
  <link rel="stylesheet" href="./static/css/bootstrap-icons.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./static/css/dashboard.css">
  <!-- Bootstrap JS -->
  <script src="./static/js/jquery-3.5.1.slim.min.js"></script>
  <script src="./static/js/bootstrap.bundle.min.js"></script>
  <!-- Vue.js -->
  <script src="./static/js/vue@2.js"></script>
  <script src="./static/js/axios.min.js"></script>
  <script src="./static/js/v-jsoneditor.min.js"></script>
</head>

<body>
  <div id="app">

    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
      <a class="navbar-brand col-md-3 col-lg-2 mr-0 px-3" href="#"><i class="bi bi-clouds"></i> 夸克自动转存</a>
      <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-toggle="collapse" data-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="navbar-actions ml-auto pr-3">
        <button type="button" class="btn btn-sm btn-outline-light navbar-config-btn" :class="{'is-active': activeTab === 'config'}" @click="changeTab('config')">
          <i class="bi bi-gear"></i> 系统配置</button>
        <a class="btn btn-sm btn-outline-light navbar-config-btn" href="/logout">
          <i class="bi bi-box-arrow-right"></i> 退出
        </a>
      </div>
    </nav>

    <div class="container-fluid">
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="sidebar-sticky pt-3">
          <ul class="nav flex-column">
            
            <li class="nav-item">
              <a class="nav-link" href="#" :class="{active: activeTab === 'tasklist'}" @click="changeTab('tasklist')">
                <i class="bi bi-list-task"></i> 任务列表
              </a>
            </li>
            <h6 class="sidebar-heading px-3 mt-4 mb-1 text-muted">dashboard</h6>
            
          </ul>
          <div class="nav-bottom text-center">
            <p class="position-relative" hidden>
              <b class="text-success"><i class="bi bi-record-circle mr-1"></i>视频教程</b>
              <span class="position-absolute qrcode-tutorial">
                使用夸克扫码查看<br>
                <img src="./static/img/qrcode_tutorial.png">
              </span>
            </p>
            <p><a target="_blank" href="https://github.com/Cp0204/quark-auto-save/wiki"><i class="bi bi-wechat mr-1"></i>使用交流</a></p>
            <p><a href="./static/js/qas.addtask.user.js"><i class="bi bi-cloud-plus-fill mr-1"></i>推送任务油猴脚本</a></p>
            <p><a target="_blank" href="https://github.com/Cp0204/quark-auto-save"><i class="bi bi-github mr-1"></i>quark-auto-save</a></p>
            <p><span v-html="versionTips"></span></p>
          </div>
        </div>
      </nav>

      <main class="col-md-9 col-lg-10 ml-sm-auto">
        <form @submit.prevent="saveConfig" @keydown.enter.prevent>

          <div v-if="activeTab === 'config'">
            <div class="section-card">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-archive section-title-icon"></i> 配置导入导出</h2>
                  <p class="section-subtitle">备份当前配置或从文件恢复。</p>
                </div>
                <div class="section-actions">
                  <button type="button" class="btn btn-outline-secondary btn-sm" @click="exportConfig"><i class="bi bi-download"></i> 导出</button>
                  <label class="btn btn-outline-secondary btn-sm mb-0">
                    <i class="bi bi-upload"></i> 导入
                    <input type="file" class="d-none" accept="application/json" @change="handleConfigImport">
                  </label>
                </div>
              </div>
              <div class="section-body small text-muted">导入会覆盖当前配置（未提供的登录信息会保留）。</div>
            </div>
            <div class="section-card">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-cookie section-title-icon"></i> Cookie</h2>
                </div>
                <div class="section-actions">
                  <button type="button" class="btn btn-outline-primary btn-sm" @click="addCookie()">+</button>
                </div>
              </div>
              <div class="section-body">
                <p class="small text-muted">1. 所有账号执行签到，纯<a class="" href="https://github.com/Cp0204/quark-auto-save/wiki/使用技巧集锦#每日签到领空间">签到</a>只需移动端参数即可！</p>
                <p class="small text-muted">2. 仅第一个账号执行转存，请自行确认顺序。<b>最好是手机验证码<a target="_blank" href="https://pan.quark.cn/">登录</a>，CK比较完整！</b>如需签到参数附在CK后面。</p>
                <div v-for="(value, index) in formData.cookie" :key="index" class="input-group mb-2">
                  <input type="text" v-model="formData.cookie[index]" class="form-control" placeholder="打开 pan.quark.com 按 F12 抓取">
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-danger" @click="removeCookie(index)">-</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section-card">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-clock section-title-icon"></i> 定时规则</h2>
                </div>
                <div class="section-actions">
                  <a class="badge badge-pill badge-light" target="_blank" href="https://tool.lu/crontab/" title="CRON时间计算器">?</a>
                </div>
              </div>
              <div class="section-body">
                <div class="input-group mb-2">
                  <div class="input-group-prepend">
                    <span class="input-group-text">Crontab</span>
                  </div>
                  <input type="text" v-model="formData.crontab" class="form-control" placeholder="必填">
                </div>
              </div>
            </div>

            <div class="section-card" title="通知推送，支持多个渠道，见Wiki">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-bell section-title-icon"></i> 通知</h2>
                </div>
                <div class="section-actions">
                  <a class="badge badge-pill badge-light" href="https://github.com/Cp0204/quark-auto-save/wiki/通知推送服务配置" target="_blank">?</a>
                  <button type="button" class="btn btn-outline-primary btn-sm" @click="addPush()">+</button>
                </div>
              </div>
              <div class="section-body">
                <div v-for="(value, key) in formData.push_config" :key="key" class="input-group mb-2">
                  <div class="input-group-prepend">
                    <span class="input-group-text" v-html="key"></span>
                  </div>
                  <div class="input-group-prepend" v-if="(key == 'DEER_KEY' || key == 'PUSH_KEY')">
                    <a type="button" class="btn btn-warning" target="_blank" href="https://sct.ftqq.com/r/13249" title="Server酱推荐计划"><i class="bi bi-award"></i></a>
                  </div>
                  <input type="text" v-model="formData.push_config[key]" class="form-control">
                  <div class="input-group-append">
                    <button type="button" class="btn btn-outline-danger" @click="removePush(key)">-</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="section-card" v-if="Object.keys(getAvailablePlugins(formData.plugins)).length" title="各插件的配置选项，具体键值由插件定义，见Wiki">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-plug section-title-icon"></i> 插件</h2>
                </div>
                <div class="section-actions">
                  <a class="badge badge-pill badge-light" href="https://github.com/Cp0204/quark-auto-save/wiki/插件配置" target="_blank">?</a>
                </div>
              </div>
              <div class="section-body">
                <div v-for="(plugin, pluginName) in getAvailablePlugins(formData.plugins)" :key="pluginName" class="sub-card">
                  <div class="form-group row mb-0" style="display:flex; align-items:center;">
                    <div data-toggle="collapse" :data-target="'#collapse_'+pluginName" aria-expanded="true" :aria-controls="'collapse_'+pluginName">
                      <div class="btn btn-block text-left">
                        <i class="bi bi-caret-right-fill"></i> <span v-html="`${pluginName}`"></span>
                      </div>
                    </div>
                  </div>
                  <div class="collapse mt-3" :id="'collapse_'+pluginName">
                    <div v-for="(value, key) in plugin" :key="key" class="form-group row">
                      <label class="col-sm-2 col-form-label" v-html="key"></label>
                      <div class="col-sm-10">
                        <input type="text" v-model="formData.plugins[pluginName][key]" class="form-control">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="section-card" title="预定义的正则匹配规则，在任务列表中可直接点击使用">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-magic section-title-icon"></i> 魔法匹配</h2>
                </div>
                <div class="section-actions">
                  <a class="badge badge-pill badge-light" href="https://github.com/Cp0204/quark-auto-save/wiki/正则处理教程#21-魔法匹配" target="_blank">?</a>
                  <button type="button" class="btn btn-outline-primary btn-sm" @click="addMagicRegex()">+</button>
                </div>
              </div>
              <div class="section-body">
                <div v-for="(value, key) in formData.magic_regex" :key="key" class="form-group mb-2">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">魔法名</span>
                    </div>
                    <input type="text" :data-oldkey="key" v-model="key" class="form-control" @change="updateMagicRegexKey($event.target.dataset.oldkey, $event.target.value)" placeholder="自定义名称">
                    <div class="input-group-prepend">
                      <span class="input-group-text">正则处理</span>
                    </div>
                    <input type="text" v-model="value.pattern" class="form-control" placeholder="匹配表达式">
                    <input type="text" v-model="value.replace" class="form-control" placeholder="替换表达式">
                    <div class="input-group-append">
                      <button type="button" class="btn btn-outline-danger" @click="removeMagicRegex(key)">-</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <div class="section-card" title="API接口，用以第三方添加任务等操作，见Wiki">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-link-45deg section-title-icon"></i> API</h2>
                </div>
                <div class="section-actions">
                  <a class="badge badge-pill badge-light" href="https://github.com/Cp0204/quark-auto-save/wiki/API接口" target="_blank">?</a>
                </div>
              </div>
              <div class="section-body">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text">Token</span>
                  </div>
                  <input type="text" v-model="formData.api_token" class="form-control" style="background-color:white;" disabled>
                </div>
              </div>
            </div>

            <div class="section-card" title="资源搜索服务配置，用于任务名称智能搜索">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-search section-title-icon"></i> 资源搜索</h2>
                </div>
              </div>
              <div class="section-body">
                <div class="sub-card">
                  <div class="form-group row mb-0" style="display:flex; align-items:center;">
                    <div data-toggle="collapse" data-target="#collapse_net" aria-expanded="true" aria-controls="collapse_net">
                      <div class="btn btn-block text-left">
                        <i class="bi bi-caret-right-fill"></i> 网络公开搜索
                      </div>
                    </div>
                  </div>
                  <div class="collapse show mt-3" id="collapse_net">
                    <div class="form-group row">
                      <label class="col-sm-2 col-form-label">启用</label>
                      <div class="col-sm-10 d-flex align-items-center">
                        <input type="checkbox" class="form-check-input" v-model="formData.source.net.enable" placeholder="是否启用网络公开搜索，默认启用">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="sub-card">
                  <div class="form-group row mb-0" style="display:flex; align-items:center;">
                    <div data-toggle="collapse" data-target="#collapse_cloudsaver" aria-expanded="true" aria-controls="collapse_cloudsaver">
                      <div class="btn btn-block text-left">
                        <i class="bi bi-caret-right-fill"></i> CloudSaver
                        <span class="badge badge-pill badge-light">
                          <a href="https://github.com/Cp0204/quark-auto-save/wiki/CloudSaver搜索源" target="_blank">?</a>
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="collapse show mt-3" id="collapse_cloudsaver">
                    <div class="form-group row">
                      <label class="col-sm-2 col-form-label">服务器</label>
                      <div class="col-sm-10">
                        <input type="text" v-model="formData.source.cloudsaver.server" class="form-control" placeholder="资源搜索服务器地址，如 http://172.17.0.1:8008">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label class="col-sm-2 col-form-label">用户名</label>
                      <div class="col-sm-10">
                        <input type="text" v-model="formData.source.cloudsaver.username" class="form-control" placeholder="用户名">
                      </div>
                    </div>
                    <div class="form-group row">
                      <label class="col-sm-2 col-form-label">密码</label>
                      <div class="col-sm-10">
                        <input type="password" v-model="formData.source.cloudsaver.password" class="form-control" placeholder="密码">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="sub-card">
                  <div class="form-group row mb-0" style="display:flex; align-items:center;">
                    <div data-toggle="collapse" data-target="#collapse_pansou" aria-expanded="true" aria-controls="collapse_pansou">
                      <div class="btn btn-block text-left">
                        <i class="bi bi-caret-right-fill"></i> PanSou
                        <span class="badge badge-pill badge-light">
                          <a href="https://github.com/fish2018/pansou" target="_blank">?</a>
                        </span>
                      </div>
                    </div>
                  </div>
                  <div class="collapse show mt-3" id="collapse_pansou">
                    <div class="form-group row">
                      <label class="col-sm-2 col-form-label">服务器</label>
                      <div class="col-sm-10">
                        <input type="text" v-model="formData.source.pansou.server" class="form-control" placeholder="资源搜索服务器地址，如 https://so.252035.xyz">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="section-card" title="smart search settings">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-sliders section-title-icon"></i> Smart Search</h2>
                </div>
              </div>
              <div class="section-body">
                <div class="form-group row">
                  <label class="col-sm-2 col-form-label">Top N</label>
                  <div class="col-sm-10">
                    <input type="number" min="1" class="form-control" v-model.number="formData.smart_search_limit" placeholder="Default 20">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-sm-2 col-form-label">Workers</label>
                  <div class="col-sm-10">
                    <input type="number" min="1" max="4" class="form-control" v-model.number="formData.smart_search_workers" placeholder="Default 2">
                  </div>
                </div>
                <div class="form-group row">
                  <label class="col-sm-2 col-form-label">Timeout (s)</label>
                  <div class="col-sm-10">
                    <input type="number" min="1" class="form-control" v-model.number="formData.smart_search_timeout" placeholder="Default 12">
                  </div>
                </div>
              </div>
            </div>


          </div>

          <div v-if="activeTab === 'tasklist'">
                        <div class="section-card">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-stars section-title-icon"></i> Smart Task List</h2>
                  <p class="section-subtitle">Only enter the show name. The program will use deep search and pick the first share link that can parse episodes.</p>
                </div>
                <div class="section-actions">
                  <input type="text" class="form-control form-control-sm smart-search" v-model="smartTaskQuery" placeholder="Search tasks">
                  <select class="form-control form-control-sm smart-sort" v-model="smartTaskSort">
                    <option value="default">Default</option>
                    <option value="name_asc">Name A-Z</option>
                    <option value="name_desc">Name Z-A</option>
                    <option value="last_run_desc">Last run</option>
                  </select>
                </div>
              </div>
              <div class="section-body">
                <div v-if="!filteredSmartTasks.length" class="empty-state">
                  <div class="empty-title">No smart tasks</div>
                  <div class="empty-sub">Add a task to start smart tracking.</div>
                  <button type="button" class="btn btn-primary btn-sm" @click="addSmartTask()"><i class="bi bi-plus"></i> Add smart task</button>
                </div>
                <div v-else>
                  <div v-for="item in filteredSmartTasks" :key="`smart-${item.index}`" class="task-card mb-3">
                    <div class="row align-items-center smart-task-summary" @click="toggleSmartCollapse(item.index, $event)" role="button">
                      <div class="col-lg-4 col-md-6 mb-2 mb-lg-0">
                        <label class="small text-muted">#S{{ item.index + 1 }} Task name</label>
                        <input type="text" class="form-control" v-model="item.task.taskname" placeholder="Required">
                      </div>
                      <div class="col-lg-5 col-md-6 mb-2 mb-lg-0">
                        <label class="small text-muted">Save path</label>
                        <div class="input-group">
                          <input type="text" class="form-control" v-model="item.task.savepath" placeholder="Required">
                          <div class="input-group-append">
                            <button class="btn btn-outline-secondary btn-sm" type="button" @click="fileSelect.sortBy='file_name';fileSelect.sortOrder='asc';showSavepathSelect(item.index, true)">Select</button>
                          </div>
                        </div>
                      </div>
                      <div class="col-lg-3 text-lg-right">
                        <button type="button" class="btn btn-outline-primary smart-run-btn" @click="runSmartTaskNow(item.index)" title="Run smart task"><i class="bi bi-play-fill"></i></button>
                      </div>
                    </div>
                    <div class="collapse mt-3" :id="`collapse_smart_${item.index}`">
                      <div class="form-group row">
                        <label class="col-sm-2 col-form-label">Save mode</label>
                        <div class="col-sm-10 col-form-label">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" :name="`smart-save-mode-${item.index}`" v-model="item.task.save_whole_folder" :value="false">
                            <label class="form-check-label">Only save latest episodes</label>
                          </div>
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" :name="`smart-save-mode-${item.index}`" v-model="item.task.save_whole_folder" :value="true">
                            <label class="form-check-label">Save whole folder (include subfolders)</label>
                          </div>
                        </div>
                      </div>
                      <div class="form-group row" v-if="!item.task.save_whole_folder">
                        <label class="col-sm-2 col-form-label">Recent episodes</label>
                        <div class="col-sm-10">
                          <input type="number" min="0" class="form-control" v-model.number="item.task.recent_episodes" placeholder="0 means no limit">
                        </div>
                      </div>
                      <div class="form-group row">
                        <label class="col-sm-2 col-form-label">Run week</label>
                        <div class="col-sm-10 col-form-label">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" :checked="item.task.runweek.length === 7" @change="toggleAllWeekdays(item.task)" :indeterminate.prop="item.task.runweek.length > 0 && item.task.runweek.length < 7">
                            <label class="form-check-label">All</label>
                          </div>
                          <div class="form-check form-check-inline" v-for="(day, index) in weekdays" :key="`smart-week-${index}`">
                            <input class="form-check-input" type="checkbox" v-model="item.task.runweek" :value="index+1">
                            <label class="form-check-label" v-html="day"></label>
                          </div>
                        </div>
                      </div>
                      <div class="form-group row" v-if="Object.keys(getAvailablePlugins(formData.plugins)).length">
                        <label class="col-sm-2 col-form-label">Plugin options</label>
                        <div class="col-sm-10">
                          <v-jsoneditor v-model="item.task.addition" :options="{mode:'tree'}" :plus="false" height="180px"></v-jsoneditor>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-sm-12 text-right">
                          <div class="btn-group" role="group" aria-label="smart-task-actions-advanced">
                            <button type="button" class="btn btn-outline-secondary btn-sm" @click="openSmartCandidates(item.index)" title="Test search"><i class="bi bi-search"></i></button>
                            <button type="button" class="btn btn-outline-danger btn-sm" @click="removeSmartTask(item.index)" title="Delete smart task"><i class="bi bi-trash3-fill"></i></button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-sm-12 text-center">
                      <div class="btn-group" role="group" aria-label="smart-task-actions">
                        <button type="button" class="btn btn-primary" @click="addSmartTask()"><i class="bi bi-plus"></i> Add smart task</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="section-card">
              <div class="section-header">
                <div>
                  <h2><i class="bi bi-clipboard-data section-title-icon"></i> Transfer Logs</h2>
                  <p class="section-subtitle">Recent runs and saved episodes.</p>
                </div>
                <div class="section-actions">
                  <select class="form-control form-control-sm logs-filter" v-model="logsFilterStatus">
                    <option value="all">All</option>
                    <option value="success">Success</option>
                    <option value="skip">Skip</option>
                    <option value="fail">Fail</option>
                  </select>
                  <button type="button" class="btn btn-outline-secondary btn-sm" @click="loadTransferLogs(true)" :disabled="logsLoading">Refresh</button>
                </div>
              </div>
              <div class="section-body">
                <div v-if="logsLoading" class="text-muted small mb-2">Loading...</div>
                <div v-else-if="logsError" class="text-danger small mb-2">{{ logsError }}</div>
                <div v-else-if="!transferLogs.length" class="empty-state compact">
                  <div class="empty-title">No logs yet</div>
                  <div class="empty-sub">Run a task to generate logs.</div>
                  <button type="button" class="btn btn-outline-secondary btn-sm" @click="loadTransferLogs(true)">Refresh</button>
                </div>
                <div v-else>
                  <div class="table-responsive logs-table-wrap" @scroll="onLogsScroll" ref="logsTable">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Time</th>
                          <th>Task</th>
                          <th>Status</th>
                          <th class="text-right">Episodes</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-if="logsTopPadding" class="log-spacer">
                          <td :style="{height: logsTopPadding + 'px'}" colspan="4"></td>
                        </tr>
                        <tr v-for="item in visibleLogs" :key="`log-${item.index}`">
                          <td v-html="item.log.created_at || ''"></td>
                          <td v-html="item.log.task_name || ''"></td>
                          <td><span class="badge badge-status" :class="statusClass(item.log.status)" v-html="item.log.status || ''"></span></td>
                          <td class="text-right log-episodes" v-html="item.log.saved_episodes || '-'"></td>
                        </tr>
                        <tr v-if="logsBottomPadding" class="log-spacer">
                          <td :style="{height: logsBottomPadding + 'px'}" colspan="4"></td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="log-actions text-center mt-2" v-if="logsHasMore">
                    <button type="button" class="btn btn-outline-secondary btn-sm" @click="loadMoreLogs()" :disabled="logsLoading">Load more</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="bottom-buttons">
            <button class="btn btn-success" data-toggle="tooltip" data-placement="top" title="保存 CTRL+S"><i class="bi bi-floppy2-fill"></i></button>
            <button type="button" class="btn btn-primary" data-toggle="tooltip" data-placement="top" title="运行 CTRL+R" @click="runScriptNow()"><i class="bi bi-play-fill"></i></button>
            <button type="button" class="btn btn-info" data-toggle="tooltip" data-placement="top" title="单击回顶，双击到底" @click="scrollToX(0)" @dblclick="scrollToX()"><i class="bi bi-chevron-bar-up"></i></button>
          </div>
        </form>
      </main>
    </div>

    <!-- 模态框 运行日志 -->
    <div class="modal" tabindex="-1" id="logModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><b>运行日志</b>
              <div v-if="modalLoading" class="spinner-border spinner-border-sm m-1" role="status"></div>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <pre v-html="run_log"></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- 模态框 文件选择 -->
    <div class="modal" tabindex="-1" id="fileSelectModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <b v-if="fileSelect.previewRegex">正则处理预览</b>
              <b v-else-if="fileSelect.selectDir">选择{{fileSelect.selectShare ? '需转存的' : '保存到的'}}文件夹</b>
              <b v-else>选择起始文件</b>
              <div v-if="modalLoading" class="spinner-border spinner-border-sm m-1" role="status"></div>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body small">
            <!-- 分享链接来源 -->
            <div class="mb-3 row" v-if="fileSelect.switchShare">
              <div class="col-sm-8">
                <div>
                  <b>名称：</b>
                  <span :title="fileSelect.share.content">{{ fileSelect.share.taskname }}</span>
                </div>
                <div>
                  <b>链接：</b>
                  <a :href="fileSelect.share.shareurl" target="_blank" @click.stop>{{ fileSelect.share.shareurl }}</a>
                </div>
                <div>
                  <b>来源：</b>
                  <span class="badge bg-transparent border border-success text-success">{{ fileSelect.share.source || "网络公开" }}</span>
                  <span class="badge bg-transparent border border-info text-info" v-if="fileSelect.share.channel">{{ fileSelect.share.channel }}</span>
                </div>
                <div v-if="fileSelect.share.datetime">
                  <b>时间：</b>
                  <span>{{ fileSelect.share.datetime }}</span>
                </div>
              </div>
              <div class="col-sm-4 text-right">
                <div class="btn-group" title="资源搜索结果切换">
                  <button type="button" class="btn btn-sm btn-outline-primary" @click="switchShare(-1)">上一个</button>
                  <button type="button" class="btn btn-sm btn-outline-primary" @click="switchShare(1)">下一个</button>
                </div>
              </div>
            </div>
            <div class="alert alert-warning" v-if="fileSelect.error" v-html="fileSelect.error"></div>
            <div v-else>
              <!-- 正则处理表达式 -->
              <div class="mb-3" v-if="fileSelect.previewRegex && fileSelect.index<this.formData.tasklist.length">
                <div><b>匹配表达式：</b><span class="badge badge-info" v-html="formData.tasklist[fileSelect.index].pattern"></span>
                  <span class="badge badge-info" v-if="formData.tasklist[fileSelect.index].pattern in formData.magic_regex">{{ formData.magic_regex[formData.tasklist[fileSelect.index].pattern].pattern }}</span>
                </div>
                <div><b>替换表达式：</b><span class="badge badge-info" v-if="formData.tasklist[fileSelect.index].replace" v-html="formData.tasklist[fileSelect.index].replace"></span>
                  <span class="badge badge-info" v-else-if="formData.tasklist[fileSelect.index].pattern in formData.magic_regex">{{ formData.magic_regex[formData.tasklist[fileSelect.index].pattern].replace }}</span>
                </div>
              </div>
              <!-- 面包屑导航 -->
              <nav aria-label="breadcrumb" v-if="fileSelect.selectDir">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item cursor-pointer" @click="navigateTo('0','/')"><i class="bi bi-house-door"></i></li>
                  <li v-for="(item, index) in fileSelect.paths" class="breadcrumb-item">
                    <a v-if="index != fileSelect.paths.length - 1" href="#" @click="navigateTo(item.fid, item.name)">{{ item.name }}</a>
                    <span v-else class="text-muted">{{ item.name }}</span>
                  </li>
                </ol>
              </nav>
              <!-- 文件列表 -->
              <table class="table table-hover table-sm">
                <thead>
                  <tr>
                    <th scope="col" class="cursor-pointer" @click="sortFileList('file_name')">
                      文件名
                      <span v-if="fileSelect.sortBy === 'file_name'">{{ fileSelect.sortOrder === "asc" ? "↑" : "↓" }}</span>
                    </th>
                    <th scope="col" v-if="fileSelect.selectShare">
                      正则处理
                    </th>
                    <template v-if="!fileSelect.previewRegex">
                      <th scope="col">
                        大小
                      </th>
                      <th scope="col" class="cursor-pointer" @click="sortFileList('updated_at')">
                        修改日期
                        <span v-if="fileSelect.sortBy === 'updated_at'">{{ fileSelect.sortOrder === "asc" ? "↑" : "↓" }}</span>
                      </th>
                      <th scope="col" v-if="!fileSelect.selectShare">
                        操作
                      </th>
                    </template>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(file, key) in fileSelect.fileList" :key="key" @click="fileSelect.selectDir ? (file.dir ? navigateTo(file.fid, file.file_name) : null) : selectStartFid(file.fid)" :class="{'cursor-pointer': fileSelect.selectDir ? file.dir : true}">
                    <td><i class="bi mr-1" :class="file.dir ? 'bi-folder-fill text-warning' : 'bi-file-earmark'"></i>{{file.file_name}}</td>
                    <td v-if="fileSelect.selectShare" :class="file.file_name_re ? 'text-success' : file.file_name_saved ? 'text-muted' : 'text-danger'">{{file.file_name_re || file.file_name_saved || '&times;'}}</td>
                    <template v-if="!fileSelect.previewRegex">
                      <td v-if="file.dir">{{ file.include_items }}项</td>
                      <td v-else>{{file.size | size}}</td>
                      <td>{{file.updated_at | ts2date}}</td>
                      <td v-if="!fileSelect.selectShare"><a class="cursor-pointer text-muted" @click.stop.prevent="deleteFile(file.fid, file.file_name, file.dir)">删除</a></td>
                    </template>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer" v-if="fileSelect.selectDir && !fileSelect.previewRegex">
            <span v-html="fileSelect.selectShare ? '转存：' : '保存到：'"></span>
            <button type="button" class="btn btn-primary btn-sm" @click="selectCurrentFolder()">当前文件夹</button>
            <button type="button" class="btn btn-primary btn-sm" v-if="!fileSelect.selectShare" @click="selectCurrentFolder(true)">当前文件夹<span class="badge badge-light" v-if="!fileSelect.isSmart && fileSelect.index<this.formData.tasklist.length" v-html="'/'+formData.tasklist[fileSelect.index].taskname"></span><span class="badge badge-light" v-else-if="fileSelect.isSmart && fileSelect.index<this.formData.smart_tasklist.length" v-html="'/'+formData.smart_tasklist[fileSelect.index].taskname"></span></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Smart candidates -->
    <div class="modal" tabindex="-1" id="smartCandidatesModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><b>Smart candidates</b>
              <div v-if="smartCandidates.loading" class="spinner-border spinner-border-sm m-1" role="status"></div>
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body small">
            <div v-if="smartCandidates.error" class="alert alert-warning" v-html="smartCandidates.error"></div>
            <div v-else>
              <div class="mb-2"><b>Task:</b> <span>{{ smartCandidates.taskname }}</span></div>
              <table class="table table-hover table-sm">
                <thead>
                  <tr>
                    <th scope="col">#</th>
                    <th scope="col">Source</th>
                    <th scope="col">Latest</th>
                    <th scope="col">Recent episodes</th>
                    <th scope="col">Share URL</th>
                    <th scope="col">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(item, idx) in smartCandidates.items" :key="`cand-${idx}`">
                    <td>{{ idx + 1 }}</td>
                    <td>
                      <span v-if="item.source">{{ item.source }}</span>
                      <span v-if="item.channel"> / {{ item.channel }}</span>
                    </td>
                    <td>{{ item.latest_episode != null ? ('E' + item.latest_episode) : 'E?' }}</td>
                    <td :title="recentFilesTitle(item)">{{ formatRecentFiles(item) }}</td>
                    <td>
                      <a :href="item.shareurl" target="_blank" @click.stop>{{ item.shareurl }}</a>
                    </td>
                    <td>
                      <button type="button" class="btn btn-outline-primary btn-sm" :disabled="!item.shareurl" @click="saveSmartCandidate(item)">Save</button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 确认弹窗 -->
    <div class="modal" tabindex="-1" id="confirmModal" data-backdrop="static" data-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content confirm-modal">
          <div class="modal-header">
            <h5 class="modal-title" v-text="confirmDialog.title"></h5>
            <button type="button" class="close" @click="confirmDialogCancel" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p class="mb-0" v-text="confirmDialog.message"></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" @click="confirmDialogCancel" v-text="confirmDialog.cancelText"></button>
            <button type="button" class="btn btn-primary" @click="confirmDialogConfirm" v-text="confirmDialog.confirmText"></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast 提示 -->
    <div class="toast-container">
      <div v-for="toast in toasts" :key="toast.id" class="toast show shadow-sm" :class="toast.type" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body d-flex align-items-center">
          <i class="bi mr-2" :class="getToastIcon(toast.type)"></i>
          <span>{{ toast.message }}</span>
          <button type="button" class="ml-auto close" @click="removeToast(toast.id)" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </div>
    </div>
  </div>


  <script>
    var app = new Vue({
      el: '#app',
      data: {
        version: "[[ version ]]",
        versionTips: "",
        plugin_flags: "[[ plugin_flags ]]",
        weekdays: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
        formData: {
          cookie: [],
          push_config: {},
          media_servers: {},
          tasklist: [],
          smart_tasklist: [],
          magic_regex: {},
          source: {
            net: {
              enable: ""
            },
            cloudsaver: {
              server: "",
              username: "",
              password: "",
              token: ""
            },
            pansou: {
              server: ""
            }
          },
          smart_search_limit: 20,
          smart_search_workers: 2,
          smart_search_timeout: 12,
        },
        toasts: [],
        newTask: {
          taskname: "",
          shareurl: "",
          savepath: "/",
          pattern: "",
          replace: "",
          enddate: "",
          addition: {},
          ignore_extension: false,
          updated_after: "",
          recent_episodes: 0,
          runweek: [1, 2, 3, 4, 5, 6, 7]
        },
        newSmartTask: {
          taskname: "",
          savepath: "/",
          pattern: "",
          replace: "",
          enddate: "",
          addition: {},
          ignore_extension: false,
          updated_after: "",
          recent_episodes: 0,
          save_whole_folder: false,
          update_subdir: "",
          update_subdir_resave_mode: false,
          runweek: [1, 2, 3, 4, 5, 6, 7]
        },
        run_log: "",
        transferLogs: [],
        logsLoading: false,
        logsError: "",
        logsFilterStatus: "all",
        logsPageSize: 50,
        logsOffset: 0,
        logsHasMore: false,
        logsScrollTop: 0,
        logsRowHeight: 32,
        logsContainerHeight: 360,
        logsBuffer: 6,
        taskDirs: [""],
        taskDirSelected: "",
        taskNameFilter: "",
        smartTaskQuery: "",
        smartTaskSort: "default",
        modalLoading: false,
        confirmDialog: {
          title: "请确认",
          message: "",
          confirmText: "确认",
          cancelText: "取消",
          pending: false,
          resolve: null,
        },
        smart_param: {
          index: null,
          savepath: "",
          origin_savepath: "",
          taskSuggestions: {},
          showSuggestions: false,
          isSearching: false,
          searchTimer: null,
        },
        activeTab: 'tasklist',
        configModified: false,
        fileSelect: {
          index: null,
          share: {},
          shareurl: "",
          stoken: "",
          fileList: [],
          paths: [],
          selectDir: true,
          selectShare: true,
          switchShare: false,
          previewRegex: false,
          sortBy: "updated_at",
          sortOrder: "desc",
          isSmart: false
        },
        smartCandidates: {
          index: null,
          taskname: "",
          items: [],
          loading: false,
          error: ""
        },
      },
      computed: {
        taskLastRunMap() {
          const map = {};
          this.transferLogs.forEach(log => {
            const name = log.task_name;
            const created = log.created_at;
            if (!name || !created) {
              return;
            }
            const ts = Date.parse(String(created).replace(' ', 'T'));
            if (!Number.isNaN(ts)) {
              if (!map[name] || ts > map[name]) {
                map[name] = ts;
              }
            }
          });
          return map;
        },
        filteredSmartTasks() {
          const query = this.smartTaskQuery.trim().toLowerCase();
          const lastRunMap = this.taskLastRunMap;
          let items = this.formData.smart_tasklist.map((task, index) => {
            const name = String(task.taskname || '');
            return {
              task,
              index,
              nameLower: name.toLowerCase(),
              lastRun: lastRunMap[name] || 0,
            };
          });
          if (query) {
            items = items.filter(item => item.nameLower.includes(query));
          }
          switch (this.smartTaskSort) {
            case 'name_asc':
              items.sort((a, b) => a.nameLower.localeCompare(b.nameLower));
              break;
            case 'name_desc':
              items.sort((a, b) => b.nameLower.localeCompare(a.nameLower));
              break;
            case 'last_run_desc':
              items.sort((a, b) => b.lastRun - a.lastRun || a.nameLower.localeCompare(b.nameLower));
              break;
            default:
              break;
          }
          return items;
        },
        logsTotalHeight() {
          return this.transferLogs.length * this.logsRowHeight;
        },
        logsVisibleStart() {
          return Math.max(0, Math.floor(this.logsScrollTop / this.logsRowHeight));
        },
        logsVisibleCount() {
          return Math.ceil(this.logsContainerHeight / this.logsRowHeight) + this.logsBuffer;
        },
        logsTopPadding() {
          return this.logsVisibleStart * this.logsRowHeight;
        },
        logsBottomPadding() {
          const remaining = this.logsTotalHeight - this.logsTopPadding - (this.visibleLogs.length * this.logsRowHeight);
          return remaining > 0 ? remaining : 0;
        },
        visibleLogs() {
          const start = this.logsVisibleStart;
          const end = Math.min(this.transferLogs.length, start + this.logsVisibleCount);
          return this.transferLogs.slice(start, end).map((log, idx) => ({
            log,
            index: start + idx,
          }));
        },
      },
      filters: {
        ts2date: function (value) {
          const date = new Date(value);
          return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
        },
        size: function (value) {
          if (!value) return "";
          const unitArr = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
          const srcsize = parseFloat(value);
          const index = srcsize ? Math.floor(Math.log(srcsize) / Math.log(1024)) : 0;
          const size = (srcsize / Math.pow(1024, index)).toFixed(1).replace(/\.?0+$/, "");
          return size + unitArr[index];
        },
      },
      watch: {
        logsFilterStatus() {
          this.loadTransferLogs(true);
        },
        formData: {
          handler(newVal, oldVal) {
            this.configModified = true;
          },
          deep: true
        }
      },
      mounted() {
        this.fetchData();
        this.loadTransferLogs(true);
        this.checkNewVersion();
        $('[data-toggle="tooltip"]').tooltip();
        document.addEventListener('keydown', this.handleKeyDown);
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.input-group')) {
            this.smart_param.showSuggestions = false;
          }
        });
        window.addEventListener('beforeunload', this.handleBeforeUnload);
      },
      beforeDestroy() {
        window.removeEventListener('beforeunload', this.handleBeforeUnload);
      },
      methods: {
        changeTab(tab) {
          this.activeTab = tab;
          if (window.innerWidth <= 768) {
            $('#sidebarMenu').collapse('toggle')
          }
        },
        checkNewVersion() {
          this.versionTips = this.version;
          axios.get('https://api.github.com/repos/Cp0204/quark-auto-save/tags')
            .then(response => {
              latestVersion = response.data[0].name;
              console.log(`检查版本：当前 ${this.version} 最新 ${latestVersion}`);
              if (latestVersion != this.version) {
                this.versionTips += ` <sup><span class="position-absolute badge badge-pill badge-danger">${latestVersion}</span></sup>`;
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
        },
        fetchData() {
          axios.get('/data')
            .then(response => {
              config_data = response.data.data
              // cookie兼容
              if (typeof config_data.cookie === 'string')
                config_data.cookie = [config_data.cookie];
              // 添加星期预设
              config_data.tasklist = config_data.tasklist.map(task => {
                if (!task.hasOwnProperty('runweek')) {
                  task.runweek = [1, 2, 3, 4, 5, 6, 7];
                }
                if (!task.hasOwnProperty('updated_after')) {
                  task.updated_after = "";
                }
                if (!task.hasOwnProperty('recent_episodes')) {
                  task.recent_episodes = 0;
                }
                if (!task.hasOwnProperty('save_whole_folder')) {
                  task.save_whole_folder = false;
                }
                return task;
              });
              if (!config_data.smart_tasklist) {
                config_data.smart_tasklist = [];
              }
              config_data.smart_tasklist = config_data.smart_tasklist.map(task => {
                if (!task.hasOwnProperty('runweek')) {
                  task.runweek = [1, 2, 3, 4, 5, 6, 7];
                }
                if (!task.hasOwnProperty('update_subdir_resave_mode')) {
                  task.update_subdir_resave_mode = false;
                }
                if (!task.hasOwnProperty('updated_after')) {
                  task.updated_after = "";
                }
                if (!task.hasOwnProperty('recent_episodes')) {
                  task.recent_episodes = 0;
                }
                return task;
              });
              // 获取所有任务父目录
              config_data.tasklist.forEach(item => {
                parentDir = this.getParentDirectory(item.savepath)
                if (!this.taskDirs.includes(parentDir))
                  this.taskDirs.push(parentDir);
              });
              this.newTask.addition = config_data.task_plugins_config_default;
              this.newSmartTask.addition = config_data.task_plugins_config_default;
              // 确保source配置存在
              if (!config_data.source) {
                config_data.source = {};
              }
              if (!config_data.source.cloudsaver) {
                config_data.source.cloudsaver = {
                  server: "",
                  username: "",
                  password: "",
                  token: ""
                };
              }
              if (!config_data.source.pansou) {
                config_data.source.pansou = {
                  server: ""
                };
              }
              if (!config_data.source.net) {
                config_data.source.net = {
                  enable: ""
                };
              }
              if (!config_data.smart_search_limit) {
                config_data.smart_search_limit = 20;
              }
              if (!config_data.smart_search_workers) {
                config_data.smart_search_workers = 2;
              }
              if (!config_data.smart_search_timeout) {
                config_data.smart_search_timeout = 12;
              }
              this.formData = config_data;
              setTimeout(() => {
                this.configModified = false;
              }, 100);
            })
            .catch(error => {
              console.error('Error fetching data:', error);
            });
        },
        exportConfig() {
          window.location.href = '/config/export';
        },
        handleConfigImport(event) {
          const file = event.target.files && event.target.files[0];
          if (!file) {
            return;
          }
          const reader = new FileReader();
          reader.onload = () => {
            let payload = null;
            try {
              payload = JSON.parse(reader.result);
            } catch (error) {
              this.showToast('配置文件不是有效 JSON', 'error');
              return;
            }
            axios.post('/config/import', payload)
              .then(response => {
                if (response.data && response.data.success) {
                  this.showToast(response.data.message || '配置导入成功', 'success');
                  this.fetchData();
                } else {
                  this.showToast((response.data && response.data.message) || '配置导入失败', 'error');
                }
              })
              .catch(error => {
                this.showToast(String(error || '配置导入失败'), 'error');
              });
          };
          reader.readAsText(file, 'utf-8');
          event.target.value = '';
        },
        loadTransferLogs(reset = false) {
          if (reset) {
            this.transferLogs = [];
            this.logsOffset = 0;
            this.logsHasMore = false;
            this.logsScrollTop = 0;
          }
          this.logsLoading = true;
          this.logsError = "";
          const params = {
            limit: this.logsPageSize,
            offset: this.logsOffset,
          };
          if (this.logsFilterStatus && this.logsFilterStatus !== 'all') {
            params.status = this.logsFilterStatus;
          }
          axios.get('/transfer_logs', { params })
            .then(response => {
              if (response.data && response.data.success) {
                const items = response.data.data || [];
                if (reset) {
                  this.transferLogs = items;
                } else {
                  this.transferLogs = this.transferLogs.concat(items);
                }
                this.logsHasMore = !!response.data.has_more;
                this.logsOffset = this.transferLogs.length;
                this.$nextTick(() => {
                  if (this.$refs.logsTable) {
                    this.logsContainerHeight = this.$refs.logsTable.clientHeight || this.logsContainerHeight;
                    if (reset) {
                      this.$refs.logsTable.scrollTop = 0;
                    }
                  }
                });
              } else {
                this.logsError = (response.data && response.data.message) || 'Failed to load logs';
              }
            })
            .catch(error => {
              this.logsError = String(error || 'Failed to load logs');
            })
            .finally(() => {
              this.logsLoading = false;
            });
        },
        loadMoreLogs() {
          if (this.logsLoading || !this.logsHasMore) {
            return;
          }
          this.loadTransferLogs(false);
        },
        onLogsScroll(event) {
          this.logsScrollTop = event.target.scrollTop;
        },

        statusClass(status) {
          if (!status) {
            return 'neutral';
          }
          const value = String(status).toLowerCase();
          if (value === 'success') {
            return 'success';
          }
          if (value === 'fail' || value === 'failed' || value === 'error') {
            return 'fail';
          }
          if (value === 'skip' || value === 'skipped') {
            return 'skip';
          }
          return 'neutral';
        },
        handleKeyDown(event) {
          if (event.ctrlKey || event.metaKey) {
            if (event.keyCode === 83 || event.key === 's') {
              event.preventDefault();
              this.saveConfig();
            } else if (event.keyCode === 82 || event.key === 'r') {
              event.preventDefault();
              this.runScriptNow();
            }
          }
        },
        handleBeforeUnload(e) {
          if (this.configModified) {
            e.preventDefault();
            e.returnValue = '配置已修改但未保存，确定要离开吗？';
            return e.returnValue;
          }
        },
        saveConfig() {
          axios.post('/update', this.formData)
            .then(response => {
              if (response.data.success) {
                this.configModified = false;
                this.showToast(response.data.message, 'success');
              } else {
                this.showToast(response.data.message, 'error');
              }
              console.log('Config saved result:', response.data);
            })
            .catch(error => {
              console.error('Error saving config:', error);
            });
        },
        addCookie() {
          this.formData.cookie.push("");
        },
        removeCookie(index) {
          if (this.formData.cookie[index] == "" || confirm("确认删除吗？"))
            this.formData.cookie.splice(index, 1);
        },
        addPush() {
          key = prompt("增加的键名", "");
          if (key != "" && key != null)
            this.$set(this.formData.push_config, key, "");
        },
        removePush(key) {
          if (confirm("确认删除吗？"))
            this.$delete(this.formData.push_config, key);
        },
        addTask() {
          newTask = { ...this.newTask }
          newTask.taskname = this.taskNameFilter;
          if (this.formData.tasklist.length > 0) {
            lastTask = this.formData.tasklist[this.formData.tasklist.length - 1];
            if (this.taskDirSelected) {
              newTask.savepath = this.taskDirSelected + '/TASKNAME';
            } else {
              if (newTask.taskname) {
                newTask.savepath = lastTask.savepath.replace(lastTask.taskname, newTask.taskname);
              } else {
                newTask.savepath = lastTask.taskname ? lastTask.savepath.replace(lastTask.taskname, 'TASKNAME') : lastTask.savepath;
              }
            }
          }
          this.formData.tasklist.push(newTask);
          // 滚到最下
          setTimeout(() => {
            $('#collapse_' + (this.formData.tasklist.length - 1)).collapse('show').on('shown.bs.collapse', () => {
              this.scrollToX();
            });
          }, 1);
        },
        addSmartTask() {
          newTask = { ...this.newSmartTask };
          newTask.taskname = this.taskNameFilter;
          if (this.formData.smart_tasklist.length > 0) {
            lastTask = this.formData.smart_tasklist[this.formData.smart_tasklist.length - 1];
            if (newTask.taskname) {
              newTask.savepath = lastTask.savepath.replace(lastTask.taskname, newTask.taskname);
            } else {
              newTask.savepath = lastTask.taskname ? lastTask.savepath.replace(lastTask.taskname, 'TASKNAME') : lastTask.savepath;
            }
          }
          this.formData.smart_tasklist.push(newTask);
        },
        removeSmartTask(index) {
          if (confirm("Confirm delete smart task [#" + (index + 1) + ": " + this.formData.smart_tasklist[index].taskname + "]?"))
            this.formData.smart_tasklist.splice(index, 1);
        },
        async runSmartTaskNow(index) {
          task = { ...this.formData.smart_tasklist[index] };
          delete task.runweek;
          delete task.enddate;
          body = {
            "smart_tasklist": [task]
          };
          this.runScriptWithBody(body, false);
        },
        async openSmartCandidates(index) {
          this.smartCandidates.index = index;
          this.smartCandidates.taskname = this.formData.smart_tasklist[index].taskname || "";
          this.smartCandidates.items = [];
          this.smartCandidates.error = "";
          this.smartCandidates.loading = true;
          $('#smartCandidatesModal').modal('toggle');
          task = { ...this.formData.smart_tasklist[index] };
          delete task.runweek;
          delete task.enddate;
          body = {
            "smart_tasklist": [task]
          };
          try {
            const response = await fetch('/smart_candidates', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });
            const result = await response.json();
            if (!result.success) {
              this.smartCandidates.error = result.message || 'Failed to load candidates';
            } else if (Array.isArray(result.data) && result.data.length > 0) {
              const first = result.data[0];
              this.smartCandidates.taskname = first.taskname || this.smartCandidates.taskname;
              this.smartCandidates.items = first.candidates || [];
            }
          } catch (error) {
            this.smartCandidates.error = String(error || 'Failed to load candidates');
          } finally {
            this.smartCandidates.loading = false;
          }
        },
        formatRecentFiles(item) {
          if (!item || !Array.isArray(item.recent_files) || item.recent_files.length === 0) {
            return '-';
          }
          const shown = item.recent_files.slice(0, 3).join(' / ');
          if (item.recent_files.length > 3) {
            return `${shown} ... (${item.recent_files.length})`;
          }
          return shown;
        },
        recentFilesTitle(item) {
          if (!item || !Array.isArray(item.recent_files) || item.recent_files.length === 0) {
            return '';
          }
          return item.recent_files.join('\n');
        },
        async saveSmartCandidate(item) {
          if (this.smartCandidates.index == null) {
            return;
          }
          task = { ...this.formData.smart_tasklist[this.smartCandidates.index] };
          delete task.runweek;
          delete task.enddate;
          task.manual_shareurl = item.shareurl;
          task.manual_source = item.source || "";
          task.manual_channel = item.channel || "";
          task.manual_latest_episode = item.latest_episode;
          task.save_whole_folder = false;
          body = {
            "smart_tasklist": [task]
          };
          $('#smartCandidatesModal').modal('toggle');
          this.runScriptWithBody(body, false);
        },
        focusTaskname(index, task) {
          this.smart_param.index = index
          this.smart_param.origin_savepath = task.savepath
          regex = new RegExp(`/${task.taskname.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}(/|$)`)
          if (task.savepath.includes('TASKNAME')) {
            this.smart_param.savepath = task.savepath;
          } else if (task.savepath.match(regex)) {
            this.smart_param.savepath = task.savepath.replace(task.taskname, 'TASKNAME');
          } else {
            this.smart_param.savepath = undefined;
          }
        },
        changeTaskname(index, task) {
          if (this.smart_param.searchTimer) {
            clearTimeout(this.smart_param.searchTimer);
          }
          this.smart_param.searchTimer = setTimeout(() => {
            this.searchSuggestions(index, task.taskname, 0);
          }, 1000);
          if (this.smart_param.savepath)
            task.savepath = this.smart_param.savepath.replace('TASKNAME', task.taskname);
        },
        removeTask(index) {
          if (confirm("确认删除任务 [#" + (index + 1) + ": " + this.formData.tasklist[index].taskname + "] 吗？"))
            this.formData.tasklist.splice(index, 1);
        },
        changeShareurl(task) {
          if (!task.shareurl)
            return;
          this.$set(task, "shareurl_ban", undefined);
          // 从URL中提取任务名
          try {
            const matches = decodeURIComponent(task.shareurl).match(/\/(\w{32})-([^\/]+)$/);
            if (matches) {
              task.taskname = task.taskname == "" ? matches[2] : task.taskname;
              task.savepath = task.savepath.replace(/TASKNAME/g, matches[2]);
            }
          } catch (e) {
            console.error("Error decodeURIComponent:", e);
          }
          // 从分享中提取任务名
          axios.post('/get_share_detail', {
            shareurl: task.shareurl
          }).then(response => {
            share_detail = response.data.data
            if (!response.data.success) {
              if (share_detail.error.includes("提取码")) {
                const passcode = prompt("检查失败[" + share_detail.error + "]，请输入提取码：");
                if (passcode != null) {
                  task.shareurl = task.shareurl.replace(/pan.quark.cn\/s\/(\w+)(\?pwd=\w*)*/, `pan.quark.cn/s/$1?pwd=${passcode}`);
                  this.changeShareurl(task);
                  return;
                }
              }
              this.$set(task, "shareurl_ban", share_detail.error);
            } else {
              task.taskname = task.taskname == "" ? share_detail.share.title : task.taskname;
              task.savepath = task.savepath.replace(/TASKNAME/g, share_detail.share.title);
              this.$set(task, "shareurl_ban", undefined);
            }
          }).catch(error => {
            console.error('Error get_share_detail:', error);
          });
        },
        clearData(target) {
          this[target] = "";
        },
        async runScriptNow(task_index = null) {
          body = {};
          if (task_index != null) {
            task = { ...this.formData.tasklist[task_index] };
            delete task.runweek;
            delete task.enddate;
            body = {
              "tasklist": [task]
            };
          } else {
            const allConfirmed = await this.showConfirm("确认运行所有任务吗？", {
              title: "运行全部任务",
              confirmText: "运行全部",
              cancelText: "取消"
            });
            if (!allConfirmed) {
              return;
            }
            if (this.configModified) {
              const configConfirmed = await this.showConfirm("检测到配置尚未保存，仍要运行吗？", {
                title: "配置未保存",
                confirmText: "继续运行",
                cancelText: "返回"
              });
              if (!configConfirmed) {
                return;
              }
            }
          }
          return this.runScriptWithBody(body, task_index == null);
        },
        async runScriptWithBody(body, refreshAfter = false, url = '/run_script_now') {
          $('#logModal').modal('toggle');
          this.modalLoading = true;
          this.run_log = '';
          try {
            // 1. send POST request
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            });
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            // 2. handle SSE stream
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let partialData = '';
            while (true) {
              const { done, value } = await reader.read();
              if (done) {
                break;
              }
              partialData += decoder.decode(value);
              const lines = partialData.split('\n').filter(line => line.trim() !== '');
              for (const line of lines) {
                if (line.startsWith('data:')) {
                  const eventData = line.substring(5).trim();
                  if (eventData === '[DONE]') {
                    this.modalLoading = false;
                    if (refreshAfter) {
                      this.fetchData();
                    }
                    this.loadTransferLogs(true);
                    this.showToast('Run completed', 'success');
                    break;
                  }
                  this.run_log += eventData.replace('<', '<​') + '\n';
                  this.$nextTick(() => {
                    const modalBody = document.querySelector('.modal-body');
                    modalBody.scrollTop = modalBody.scrollHeight;
                  });
                } else {
                  console.warn('Unexpected line:', line);
                }
              }
              partialData = '';
            }
          } catch (error) {
            this.modalLoading = false;
            this.showToast('Run failed', 'error');
            console.error('Error:', error);
          }
        },
        getParentDirectory(path) {
          parentDir = path.substring(0, path.lastIndexOf('/'))
          if (parentDir == "")
            parentDir = "/"
          return parentDir;
        },
        scrollToX(top = undefined) {
          if (top == undefined)
            top = document.documentElement.scrollHeight
          window.scrollTo({
            top: top,
            behavior: "smooth"
          });
        },
        getAvailablePlugins(plugins) {
          availablePlugins = {};
          const pluginsFlagsArray = this.plugin_flags.split(',');
          for (const pluginName in plugins) {
            if (!pluginsFlagsArray.includes(`-${pluginName}`)) {
              availablePlugins[pluginName] = plugins[pluginName];
            }
          }
          return availablePlugins;
        },
        showConfirm(message, options = {}) {
          this.confirmDialog.title = options.title || "请确认";
          this.confirmDialog.message = message || "";
          this.confirmDialog.confirmText = options.confirmText || "确认";
          this.confirmDialog.cancelText = options.cancelText || "取消";
          this.confirmDialog.pending = true;
          return new Promise((resolve) => {
            this.confirmDialog.resolve = resolve;
            $('#confirmModal').modal('show');
          });
        },
        confirmDialogResolve(result) {
          if (!this.confirmDialog.pending) {
            return;
          }
          this.confirmDialog.pending = false;
          const resolve = this.confirmDialog.resolve;
          this.confirmDialog.resolve = null;
          if (resolve) {
            resolve(result);
          }
        },
        confirmDialogConfirm() {
          this.confirmDialogResolve(true);
          $('#confirmModal').modal('hide');
        },
        confirmDialogCancel() {
          this.confirmDialogResolve(false);
          $('#confirmModal').modal('hide');
        },
        toggleAllWeekdays(task) {
          if (task.runweek.length === 7) {
            task.runweek = [];
          } else {
            task.runweek = [1, 2, 3, 4, 5, 6, 7];
          }
        },
        toggleSmartCollapse(index, event) {
          const collapse = document.getElementById(`collapse_smart_${index}`);
          if (!collapse) {
            return;
          }
          const isOpen = collapse.classList.contains('show');
          if (isOpen && this.isSmartToggleBlocked(event)) {
            return;
          }
          $(collapse).collapse(isOpen ? 'hide' : 'show');
        },
        isSmartToggleBlocked(event) {
          if (!event || !event.target) {
            return false;
          }
          return Boolean(
            event.target.closest('input, textarea, select, button, a, .btn, .form-control, .input-group, .form-check')
          );
        },
        searchSuggestions(index, taskname, deep = 1) {
          taskname = taskname.replace(/\((19|20)\d{2}\)/g, '').trim();
          if (taskname.length < 2) {
            console.log(`任务名[${taskname}]过短${taskname.length} 不进行搜索`);
            return;
          }
          this.smart_param.isSearching = true;
          this.smart_param.index = index;
          try {
            axios.get('/task_suggestions', {
              params: {
                q: taskname,
                d: deep
              }
            }).then(response => {
              this.smart_param.taskSuggestions = response.data;
              this.smart_param.showSuggestions = true;
            }).catch(error => {
              console.error('Error fetching suggestions:', error);
            }).finally(() => {
              this.smart_param.isSearching = false;
            });
          } catch (e) {
            this.smart_param.taskSuggestions = {
              error: "网络异常"
            };
          }
        },
        selectSuggestion(index, suggestion) {
          this.smart_param.showSuggestions = false;
          this.fileSelect.selectDir = true;
          this.fileSelect.switchShare = true;
          this.fileSelect.previewRegex = false;
          this.fileSelect.share = suggestion;
          this.showShareSelect(index, suggestion.shareurl);
        },
        addMagicRegex() {
          const newKey = `$MAGIC_${Object.keys(this.formData.magic_regex).length + 1}`;
          this.$set(this.formData.magic_regex, newKey, { pattern: '', replace: '' });
        },
        updateMagicRegexKey(oldKey, newKey) {
          if (oldKey !== newKey) {
            if (this.formData.magic_regex[newKey]) {
              this.showToast(`魔法名 [${newKey}] 已存在，请使用其他名称`, 'warning');
              return;
            }
            this.$set(this.formData.magic_regex, newKey, this.formData.magic_regex[oldKey]);
            this.$delete(this.formData.magic_regex, oldKey);
          }
        },
        removeMagicRegex(key) {
          if (confirm(`确认删除魔法匹配规则 [${key}] 吗？`)) {
            this.$delete(this.formData.magic_regex, key);
          }
        },
        deleteFile(fid, fname, isDir) {
          if (fid != "" && confirm(`确认删除${isDir ? '目录' : '文件'} [${fname}] 吗？`))
            axios.post('/delete_file', {
              fid: fid
            }).then(response => {
              if (response.data.code == 0) {
                this.fileSelect.fileList = this.fileSelect.fileList.filter(item => item.fid != fid);
              } else {
                this.showToast('删除失败：' + response.data.message, 'error');
              }
            }).catch(error => {
              console.error('Error /delete_file:', error);
            });
        },
        getSavepathDetail(params = 0) {
          if (params.includes('/')) {
            params = { path: params }
          } else {
            params = { fid: params }
          }
          this.modalLoading = true;
          axios.get('/get_savepath_detail', {
            params: params
          }).then(response => {
            this.fileSelect.fileList = response.data.data.list;
            this.sortFileList(this.fileSelect.sortBy, this.fileSelect.sortOrder);
            if (response.data.data.paths?.length > 0) {
              this.fileSelect.paths = response.data.data.paths
            }
            this.modalLoading = false;
          }).catch(error => {
            console.error('Error /get_savepath_detail:', error);
            this.fileSelect.error = "获取文件夹列表失败";
            this.modalLoading = false;
          });
        },
        showSavepathSelect(index, isSmart = false) {
          this.fileSelect.selectShare = false;
          this.fileSelect.selectDir = true;
          this.fileSelect.switchShare = false;
          this.fileSelect.previewRegex = false;
          this.fileSelect.error = undefined;
          this.fileSelect.fileList = [];
          this.fileSelect.paths = [];
          this.fileSelect.index = index;
          this.fileSelect.isSmart = isSmart;
          $('#fileSelectModal').modal('toggle');
          const list = isSmart ? this.formData.smart_tasklist : this.formData.tasklist;
          list[index].savepath = list[index].savepath.replace(/\/+/g, "/");
          this.getSavepathDetail(list[index].savepath);
        },
        getShareDetail() {
          this.modalLoading = true;
          axios.post('/get_share_detail', {
            shareurl: this.fileSelect.shareurl,
            stoken: this.fileSelect.stoken,
            task: this.formData.tasklist[this.fileSelect.index],
            magic_regex: this.formData.magic_regex,
          }).then(response => {
            if (response.data.success) {
              this.fileSelect.fileList = response.data.data.list;
              this.sortFileList(this.fileSelect.sortBy, this.fileSelect.sortOrder);
              this.fileSelect.paths = response.data.data.paths;
              this.fileSelect.stoken = response.data.data.stoken;
            } else {
              this.fileSelect.error = response.data.data.error
            }
            this.modalLoading = false;
          }).catch(error => {
            console.error('Error getting folders:', error);
            this.fileSelect.error = "获取文件夹列表失败";
            this.modalLoading = false;
          });
        },
        showShareSelect(index, shareurl = null) {
          this.fileSelect.selectShare = true;
          this.fileSelect.fileList = [];
          this.fileSelect.paths = [];
          this.fileSelect.error = undefined;
          // 如果分享链接发生变化，则重置 stoken
          const newShareurl = shareurl || this.formData.tasklist[index].shareurl
          if (this.getShareurl(this.fileSelect.shareurl) != this.getShareurl(newShareurl)) {
            this.fileSelect.stoken = "";
          }
          this.fileSelect.shareurl = newShareurl;
          this.fileSelect.index = index;
          $('#fileSelectModal').modal('toggle');
          this.getShareDetail();
        },
        switchShare(index) {
          currentIndex = this.smart_param.taskSuggestions.data.indexOf(this.fileSelect.share);
          nextIndex = currentIndex + index;
          if (nextIndex < 0) {
            this.showToast("没有上一个啦", "info");
          } else if (nextIndex >= this.smart_param.taskSuggestions.data.length) {
            this.showToast("没有下一个啦", "info");
          } else {
            this.fileSelect.error = "";
            this.fileSelect.stoken = "";
            this.fileSelect.share = this.smart_param.taskSuggestions.data[nextIndex];
            this.fileSelect.shareurl = this.smart_param.taskSuggestions.data[nextIndex].shareurl;
            this.fileSelect.paths = [];
            this.fileSelect.fileList = [];
            this.getShareDetail();
          }
        },
        navigateTo(fid, name) {
          dir = { fid: fid, name: name }
          if (this.fileSelect.selectShare) {
            this.fileSelect.shareurl = this.getShareurl(this.fileSelect.shareurl, dir);
            this.getShareDetail();
          } else {
            if (fid == "0") {
              this.fileSelect.paths = []
            } else {
              index = this.fileSelect.paths.findIndex(item => item.fid === fid);
              if (index !== -1) {
                this.fileSelect.paths = this.fileSelect.paths.slice(0, index + 1)
              } else {
                this.fileSelect.paths.push({ fid: fid, name: name })
              }
            }
            this.getSavepathDetail(fid);
          }
        },
        selectCurrentFolder(addTaskname = false) {
          if (this.fileSelect.selectShare) {
            this.formData.tasklist[this.fileSelect.index].shareurl_ban = undefined;
            this.formData.tasklist[this.fileSelect.index].shareurl = this.fileSelect.shareurl;
          } else {
            const list = this.fileSelect.isSmart ? this.formData.smart_tasklist : this.formData.tasklist;
            list[this.fileSelect.index].savepath = "/" + this.fileSelect.paths.map(item => item.name).join("/");
            if (addTaskname) {
              list[this.fileSelect.index].savepath += "/" + list[this.fileSelect.index].taskname
            }
          }
          $('#fileSelectModal').modal('hide')
        },
        selectStartFid(fid) {
          Vue.set(this.formData.tasklist[this.fileSelect.index], 'startfid', fid);
          $('#fileSelectModal').modal('hide')
        },
        getShareurl(shareurl, dir = {}) {
          if (dir == {} || dir.fid == 0) {
            shareurl = shareurl.match(`.*s/[a-z0-9]+(\\?pwd=[^#]+)?`)[0]
          } else if (shareurl.includes(dir.fid)) {
            shareurl = shareurl.match(`.*/${dir.fid}[^/]*`)[0]
          } else if (shareurl.includes('#/list/share')) {
            shareurl = `${shareurl.split('#')[0]}#/list/share/${dir.fid}`
          } else {
            shareurl = `${shareurl.split('#')[0]}#/list/share/${dir.fid}`
          }
          return shareurl;
        },
        sortFileList(column, order) {
          if (this.fileSelect.sortBy === column && !order) {
            this.fileSelect.sortOrder = this.fileSelect.sortOrder === "asc" ? "desc" : "asc";
          } else {
            this.fileSelect.sortBy = column;
            this.fileSelect.sortOrder = order || "asc";
          }

          this.fileSelect.fileList.sort((a, b) => {
            let valA = a[this.fileSelect.sortBy];
            let valB = b[this.fileSelect.sortBy];

            if (typeof valA === "string") valA = valA.toLowerCase();
            if (typeof valB === "string") valB = valB.toLowerCase();

            if (valA < valB) return this.fileSelect.sortOrder === "asc" ? -1 : 1;
            if (valA > valB) return this.fileSelect.sortOrder === "asc" ? 1 : -1;
            return 0;
          });
        },
        inputRawMagicRegex(task) {
          const item = this.formData.magic_regex[task.pattern];
          if (item) {
            task.pattern = item.pattern;
            task.replace = item.replace;
          }
        },
        copyText(text, callback = () => { }) {
          if (!text) {
            console.error('No text to copy');
            return;
          }
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text);
          } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.top = '0';
            textarea.style.left = '0';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            document.execCommand("copy");
            document.body.removeChild(textarea);
          }
          callback()
        },
        copyTaskToClipboard(index) {
          const task = { ...this.formData.tasklist[index] };
          delete task.addition;
          const _this = this;
          this.copyText(JSON.stringify(task), function () {
            _this.showToast("任务参数已复制到剪贴板", "success");
          });
        },
        async addTaskForClipboard() {
          text = null
          try {
            text = await navigator.clipboard.readText();
          } catch (error) {
            text = prompt("当前环境不支持自动读取粘贴板，请手动粘贴任务参数", "");
          }
          if (text) {
            try {
              let task = JSON.parse(text);
              task = { ...this.newTask, ...task };
              this.formData.tasklist.push(task);
              this.showToast("剪贴板参数已成功导入任务", "success");
              // 滚到最下
              setTimeout(() => {
                $('#collapse_' + (this.formData.tasklist.length - 1)).collapse('show').on('shown.bs.collapse', () => {
                  this.scrollToX();
                });
              }, 1);
            } catch (error) {
              this.showToast("解析剪贴板内容失败", "error");
            }
          }
        },
        showToast(message, type = 'info', duration = 3000) {
          const id = Date.now();
          this.toasts.push({ id, message, type });
          setTimeout(() => {
            this.removeToast(id);
          }, duration);
        },
        removeToast(id) {
          this.toasts = this.toasts.filter(t => t.id !== id);
        },
        getToastIcon(type) {
          switch (type) {
            case 'success': return 'bi-check-circle-fill text-success';
            case 'error': return 'bi-exclamation-circle-fill text-danger';
            case 'warning': return 'bi-exclamation-triangle-fill text-warning';
            default: return 'bi-info-circle-fill text-info';
          }
        },
      }
    });
  </script>
</body>

</html>
